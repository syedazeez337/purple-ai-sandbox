name: "cicd-worker"
description: "Scenario 3: Build worker. Balanced profile, access to build tools."

filesystem:
  immutable_paths:
    - host_path: "/usr"
      sandbox_path: "/usr"
    - host_path: "/lib64"
      sandbox_path: "/lib64"
    - host_path: "/bin"
      sandbox_path: "/bin"
    - host_path: "/etc/passwd"
      sandbox_path: "/etc/passwd"
    - host_path: "/etc/group"
      sandbox_path: "/etc/group"
  scratch_paths:
    - "/tmp"
    - "/var/tmp"
    - "/build"
  output_paths:
    - host_path: "/tmp/purple/output/cicd-worker"
      sandbox_path: "/build"
  working_dir: "/tmp"

syscalls:
  default_deny: false
  allow:
    # File I/O operations - required for file operations
    - "read"
    - "write"
    - "openat"
    - "close"
    - "fstat"
    - "newfstatat"
    - "lseek"
    - "pread64"
    - "writev"
    - "readlink"
    - "stat"
    - "statx"
    - "access"
    - "getdents64"
    - "unlink"
    - "rename"
    - "mkdir"
    - "rmdir"

    # Memory management
    - "mmap"
    - "mprotect"
    - "munmap"
    - "brk"
    - "madvise"
    - "mremap"

    # Process operations
    - "execve"
    - "execveat"
    - "exit_group"
    - "exit"
    - "wait4"
    - "clone"
    - "clone3"
    - "fork"
    - "vfork"

    # Signal handling
    - "rt_sigaction"
    - "rt_sigprocmask"
    - "rt_sigreturn"
    - "sigaltstack"
    - "kill"
    - "tkill"
    - "tgkill"

    # Thread and concurrency
    - "set_tid_address"
    - "set_robust_list"
    - "rseq"
    - "futex"
    - "nanosleep"
    - "clock_nanosleep"
    - "clock_gettime"

    # File descriptor operations
    - "dup"
    - "dup2"
    - "pipe"
    - "pipe2"
    - "fcntl"
    - "flock"
    - "ioctl"

    # Process identification and credentials
    - "getpid"
    - "getuid"
    - "getgid"
    - "geteuid"
    - "getegid"
    - "getppid"
    - "getpgid"
    - "getsid"
    - "getgroups"
    - "getrlimit"
    - "prlimit64"
    - "setuid"
    - "setgid"
    - "setpgid"
    - "setsid"

    # System information
    - "uname"
    - "sysinfo"
    - "getrandom"
    - "arch_prctl"

    # Current working directory
    - "getcwd"
    - "chdir"
    - "fchdir"

    # Socket operations (for network access)
    - "socket"
    - "connect"
    - "sendto"
    - "recvfrom"
    - "sendmsg"
    - "recvmsg"
    - "setsockopt"
    - "getsockopt"
    - "shutdown"
    - "bind"
    - "listen"
    - "accept"
    - "getpeername"
    - "getsockname"

    # Event polling
    - "poll"
    - "ppoll"
    - "epoll_create"
    - "epoll_create1"
    - "epoll_ctl"
    - "epoll_wait"
    - "epoll_pwait"
    - "select"

    # Timer operations
    - "timer_create"
    - "timer_settime"
    - "timer_gettime"
    - "timer_getoverrun"
    - "timer_delete"
    - "getitimer"
    - "setitimer"

    # Shared memory
    - "shmget"
    - "shmat"
    - "shmctl"
    - "shmdt"

    # Semaphore operations
    - "semget"
    - "semop"
    - "semctl"
    - "semtimedop"

    # Message queues
    - "msgget"
    - "msgsnd"
    - "msgrcv"
    - "msgctl"

    # Memory mapping
    - "mbind"
    - "set_mempolicy"
    - "get_mempolicy"

    # File system operations
    - "chmod"
    - "chown"
    - "fchown"
    - "umask"
    - "getxattr"
    - "setxattr"
    - "listxattr"
    - "removexattr"
    - "symlink"
    - "link"
    - "readlinkat"
    - "newfstatat"

    # build tool specific syscalls
    - "sched_setaffinity"
    - "sched_getaffinity"
    - "sched_yield"
    - "getcpu"

  deny:
    # Dangerous syscalls that should always be blocked
    - "mount"
    - "umount2"
    - "pivot_root"
    - "chroot"
    - "kexec_load"
    - "init_module"
    - "delete_module"
    - "finit_module"
    - "request_key"
    - "add_key"
    - "keyctl"
    - "ptrace"
    - "process_vm_readv"
    - "process_vm_writev"
    - "personality"
    - "reboot"
    - "settimeofday"
    - "adjtimex"
    - "clock_settime"

resources:
  cpu_shares: 0.8
  memory_limit_bytes: "2G"
  pids_limit: 200
  io_limit_bytes_per_sec: "100M"
  session_timeout_seconds: 1200

capabilities:
  default_drop: true
  add: []

network:
  isolated: false
  allow_outgoing:
    - "443"
    - "80"
    - "22"
    - "8080"
  allow_incoming: []

audit:
  enabled: true
  log_path: "/tmp/purple/audit/cicd-worker.log"
  detail_level: ["syscall", "filesystem", "resource"]
